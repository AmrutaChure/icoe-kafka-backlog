name: Auto-close issues when project Status is "Done"

on:
  schedule:
    - cron: '*/15 * * * *'  # Runs every 15 minutes
  workflow_dispatch:        # Allows manual trigger

jobs:
  close_done_issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Close issues with Status = Done
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const org = 'kafkaNchai'; // <-- Replace this
            const projectNumber = 4; // <-- Replace this
            const statusFieldName = 'Status';
            const doneStatusValue = 'âœ… Done';

            async function getProjectId() {
             const query = `
  query($user: String!) {
    user(login: $user) {
      projectV2(number: ${projectNumber}) {
        id
      }
    }
  }`;
const data = await github.graphql(query, { user: org });
return data.user.projectV2.id;


            async function getItems(projectId) {
              const items = [];
              let cursor = null;
              const query = `
                query($projectId: ID!, $cursor: String) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 50, after: $cursor) {
                        pageInfo {
                          hasNextPage
                          endCursor
                        }
                        nodes {
                          id
                          content {
                            ... on Issue {
                              id
                              number
                              state
                              title
                              repository {
                                name
                                owner {
                                  login
                                }
                              }
                            }
                          }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                name
                                field {
                                  ... on ProjectV2SingleSelectField {
                                    name
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }`;

              while (true) {
                const result = await github.graphql(query, { projectId, cursor });
                const data = result.node.items;
                for (const item of data.nodes) {
                  if (item.content && item.content.state === 'OPEN') {
                    const statusField = item.fieldValues.nodes.find(f =>
                      f.field?.name === statusFieldName
                    );
                    if (statusField && statusField.name === doneStatusValue) {
                      items.push(item);
                    }
                  }
                }
                if (!data.pageInfo.hasNextPage) break;
                cursor = data.pageInfo.endCursor;
              }

              return items;
            }

            const projectId = await getProjectId();
            const itemsToClose = await getItems(projectId);

            for (const item of itemsToClose) {
              const issue = item.content;
              console.log(`Closing issue #${issue.number} in ${issue.repository.owner.login}/${issue.repository.name}...`);
              await github.rest.issues.update({
                owner: issue.repository.owner.login,
                repo: issue.repository.name,
                issue_number: issue.number,
                state: 'closed'
              });
            }
